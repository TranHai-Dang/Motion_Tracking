<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title> Kids Monitor</title>
    <style>
        body { background: #1e272e; color: #d2dae2; font-family: 'Segoe UI', sans-serif; text-align: center; margin: 0; }
        .container { max-width: 1280px; margin: 0 auto; padding: 20px; }
        
        .grid-container { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .cam-box { background: #000; border: 4px solid #485460; border-radius: 12px; overflow: hidden; position: relative; aspect-ratio: 16/9; }
        img { width: 100%; height: 100%; object-fit: contain; }
        .cam-title { position: absolute; top: 10px; left: 10px; background: rgba(0,0,0,0.7); padding: 5px 10px; border-radius: 5px; font-weight: bold; }

        /* TH·ªêNG K√ä L·ªñI */
        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin: 20px 0; }
        .stat-card { background: #2f3640; padding: 15px; border-radius: 10px; border-top: 5px solid #7f8fa6; display: flex; flex-direction: column; align-items: center; }
        .stat-val { font-size: 36px; font-weight: bold; color: white; }
        .stat-name { font-size: 14px; color: #aaa; text-transform: uppercase; margin-top: 5px; }
        
        .card-neck { border-color: #f1c40f; } .card-back { border-color: #e67e22; }
        .card-tilt { border-color: #3498db; } .card-close { border-color: #9b59b6; }

        /* INPUT PANEL */
        .control-panel { background: #485460; padding: 15px; border-radius: 12px; display: flex; gap: 10px; justify-content: center; margin-bottom: 20px; align-items: center;}
        
        input { padding: 10px; border-radius: 5px; border: none; font-size: 16px; text-align: center; font-weight: bold; }
        #nameInput { width: 160px; background: #dfe6e9; color: #2d3436; }
        #ageInput { width: 60px; background: #dfe6e9; color: #2d3436; }
        #durationInput { width: 60px; background: #81ecec; color: #000; }

        button { padding: 10px 20px; border-radius: 5px; border: none; font-size: 16px; cursor: pointer; color: white; font-weight: bold;}
        #btnStart { background: #05c46b; }
        #btnStop { background: #ff3f34; display: none; }
        
        table { width: 100%; background: white; color: #333; border-collapse: collapse; border-radius: 8px; overflow: hidden; font-size: 14px;}
        th, td { padding: 10px; border-bottom: 1px solid #ddd; text-align: center; }
        th { background: #34495e; color: white; }
    </style>
</head>
<body>

<div class="container">
    <h2>üë∂ H·ªÜ TH·ªêNG GI√ÅM S√ÅT T∆Ø TH·∫æ H·ªåC T·∫¨P</h2>
    
    <div class="grid-container">
        <div class="cam-box" id="box-front">
            <div class="cam-title">CAM TR∆Ø·ªöC </div>
            <img src="{{ url_for('video_front') }}">
        </div>
        <div class="cam-box" id="box-side">
            <div class="cam-title">CAM C·∫†NH </div>
            <img src="{{ url_for('video_side') }}">
        </div>
    </div>

    <div class="stats-grid">
        <div class="stat-card card-neck"><div class="stat-val" id="cnt-neck">0</div><div class="stat-name">G√π C·ªï</div></div>
        <div class="stat-card card-back"><div class="stat-val" id="cnt-back">0</div><div class="stat-name">G√π L∆∞ng</div></div>
        <div class="stat-card card-tilt"><div class="stat-val" id="cnt-tilt">0</div><div class="stat-name">Nghi√™ng ƒê·∫ßu</div></div>
        <div class="stat-card card-close"><div class="stat-val" id="cnt-close">0</div><div class="stat-name">D√≠ M·∫Øt</div></div>
    </div>
    
    <div id="statusMessage" style="color:#aaa; margin-bottom: 10px; font-weight:bold;">S·∫µn s√†ng...</div>

    <div class="control-panel">
        <input type="text" id="nameInput" placeholder="T√™n B√©">
        <input type="number" id="ageInput" placeholder="Tu·ªïi">
        <span style="color: white;">| M·ª•c ti√™u:</span>
        <input type="number" id="durationInput" value="45"> ph√∫t

        <button id="btnStart" onclick="startSession()">‚ñ∂ B·∫ÆT ƒê·∫¶U</button>
        <button id="btnStop" onclick="finishSession()">‚èπ K·∫æT TH√öC</button>
        <button onclick="calibrate()" style="background:#0fb9b1;">Set Chu·∫©n</button>
    </div>

    <h3>üìú L·ªãch s·ª≠ r√®n luy·ªán</h3>
    <table>
        <thead>
            <tr>
                <th>Th·ªùi gian</th>
                <th>T√™n B√©</th>
                <th>Tu·ªïi</th>
                <th>H·ªçc th·∫≠t</th>
                <th>T·ªïng L·ªói</th>
                <th>Chi ti·∫øt</th>
                <th>X·∫øp lo·∫°i</th>
            </tr>
        </thead>
        <tbody id="historyBody"></tbody>
    </table>
</div>

<audio id="alarmSound" src="https://assets.mixkit.co/sfx/preview/mixkit-alarm-digital-clock-beep-989.mp3"></audio>

<script>
    loadHistory();

    function startSession() {
        const name = document.getElementById('nameInput').value;
        const age = document.getElementById('ageInput').value;
        const dur = document.getElementById('durationInput').value;

        if(!name || !age) { alert("Nh·∫≠p T√™n v√† Tu·ªïi!"); return; }

        fetch('/start_session', {
            method:'POST', headers:{'Content-Type':'application/json'}, 
            body:JSON.stringify({name: name, age: age, duration: dur})
        })
        .then(res=>res.json()).then(d => {
            document.getElementById('nameInput').disabled = true;
            document.getElementById('ageInput').disabled = true;
            document.getElementById('btnStart').style.display='none';
            document.getElementById('btnStop').style.display='inline-block';
            resetCounts();
        });
    }

    function finishSession() {
        fetch('/stop_session', {method:'POST'}).then(res=>res.json()).then(d => {
            const sumErr = d.errors.neck + d.errors.back + d.errors.tilt + d.errors.close;
            alert(`K·∫æT TH√öC!\n- B√©: ${document.getElementById('nameInput').value}\n- T·ªïng l·ªói: ${sumErr}`);
            document.getElementById('nameInput').disabled = false;
            document.getElementById('ageInput').disabled = false;
            document.getElementById('btnStart').style.display='inline-block';
            document.getElementById('btnStop').style.display='none';
            loadHistory();
        });
    }

    function calibrate() { fetch('/calibrate_front').then(r=>r.json()).then(d=>alert(d.status)); }
    function resetCounts() { ['neck','back','tilt','close'].forEach(k => document.getElementById(`cnt-${k}`).innerText = "0"); }

    function loadHistory() {
        fetch('/get_history').then(r=>r.json()).then(logs => {
            const tb = document.getElementById('historyBody'); tb.innerHTML="";
            logs.forEach(log => {
                const err = parseInt(log['T·ªïng L·ªói']);
                let rank = "üèÜ Ngoan";
                let color = "green";
                if(err > 5) { rank = "üòê Kh√°"; color = "orange"; }
                if(err > 15) { rank = "‚ö†Ô∏è K√©m"; color = "red"; }
                
                // Hi·ªÉn th·ªã chi ti·∫øt l·ªói nh·ªè
                let details = `C·ªï:${log['G√π C·ªï']}, L∆∞ng:${log['G√π L∆∞ng']}, M·∫Øt:${log['D√≠ M·∫Øt']}`;

                tb.innerHTML += `<tr>
                    <td>${log['Th·ªùi gian']}</td>
                    <td style="font-weight:bold">${log['T√™n B√©']}</td>
                    <td>${log['Tu·ªïi']}</td>
                    <td>${log['Th·ª±c h·ªçc(p)']}p</td>
                    <td style="font-weight:bold; color:red">${err}</td>
                    <td style="font-size:12px">${details}</td>
                    <td style="color:${color}; font-weight:bold">${rank}</td>
                </tr>`;
            });
        });
    }

    setInterval(() => {
        fetch('/check_status').then(r=>r.json()).then(data => {
            const aud = document.getElementById('alarmSound');
            const msg = document.getElementById('statusMessage');
            
            if(data.counts) {
                document.getElementById('cnt-neck').innerText = data.counts.neck;
                document.getElementById('cnt-back').innerText = data.counts.back;
                document.getElementById('cnt-tilt').innerText = data.counts.tilt;
                document.getElementById('cnt-close').innerText = data.counts.close;
            }

            if(!data.active) return;
            if(data.absent) {
                msg.innerText = "‚ö†Ô∏è B√â V·∫ÆNG M·∫∂T"; msg.style.color = "yellow";
                aud.pause(); return;
            }

            if(data.alarm) {
                msg.innerText = "üö® SAI T∆Ø TH·∫æ!"; msg.style.color = "red";
                aud.play().catch(()=>{});
            } else {
                msg.innerText = "‚úÖ T∆Ø TH·∫æ T·ªêT"; msg.style.color = "#2ecc71";
                aud.pause(); aud.currentTime=0;
            }
        });
    }, 500);
</script>

</body>
</html>
